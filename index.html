<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Металлы (реальный спот) — мини-дашборд</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--text:#e7eefc;--muted:#a8b3cf;--up:#3bd671;--down:#ff6b6b;}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 16px;line-height:1.4}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns: 1fr 1fr;}}
    .card{background:var(--card);border-radius:14px;padding:14px 14px 10px}
    .card h2{font-size:15px;margin:0 0 10px;color:#c7d2f0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}
    th{color:#c7d2f0;font-weight:600}
    tr:last-child td{border-bottom:0}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .na{background:rgba(168,179,207,.12);color:var(--muted)}
    .btn{display:inline-block;background:#1b2540;color:white;border:0;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .ok{color:var(--up)} .bad{color:var(--down)}
    .tvbox{border-radius:12px;overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Реальные цены металлов (spot) + макро в одном месте</h1>
    <p class="sub">
      Для покупок в банке ориентируйся на <b>XAUUSD / XAGUSD (spot)</b> и сравнивай с ценой банка (премия/спред).<br/>
      Спот берём из metals.live (простая API). Макро/индикаторы — через виджеты TradingView (обычно работают без проблем в браузере).
    </p>

    <div class="row" style="margin-bottom:12px">
      <div class="small">Автообновление spot: <span id="interval">60</span> сек • Обновлено: <span id="ts">—</span></div>
      <button class="btn" id="refreshBtn">Обновить сейчас</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Металлы spot (USD)</h2>
        <table>
          <thead>
            <tr>
              <th>Актив</th>
              <th>Тикер</th>
              <th>Цена</th>
              <th>Источник</th>
            </tr>
          </thead>
          <tbody id="spotBody">
            <tr><td colspan="4"><span class="chip na">загрузка…</span></td></tr>
          </tbody>
        </table>
        <p class="small" style="margin:10px 0 0">
          Примечание: банки добавляют премию/спред к споту. Для решений смотри дневной/недельный график.
        </p>
      </div>

      <div class="card">
        <h2>Макро и ориентиры (виджеты)</h2>
        <div class="tvbox">
          <!-- TradingView Market Overview Widget -->
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
            {
              "colorTheme": "dark",
              "dateRange": "1M",
              "showChart": true,
              "locale": "ru",
              "largeChartUrl": "",
              "isTransparent": true,
              "showSymbolLogo": true,
              "showFloatingTooltip": true,
              "width": "100%",
              "height": "420",
              "plotLineColorGrowing": "rgba(59, 214, 113, 1)",
              "plotLineColorFalling": "rgba(255, 107, 107, 1)",
              "gridLineColor": "rgba(255, 255, 255, 0.06)",
              "scaleFontColor": "rgba(168, 179, 207, 1)",
              "belowLineFillColorGrowing": "rgba(59, 214, 113, 0.12)",
              "belowLineFillColorFalling": "rgba(255, 107, 107, 0.12)",
              "belowLineFillColorGrowingBottom": "rgba(59, 214, 113, 0)",
              "belowLineFillColorFallingBottom": "rgba(255, 107, 107, 0)",
              "symbolActiveColor": "rgba(27, 37, 64, 1)",
              "tabs": [
                {
                  "title": "Металлы и доллар",
                  "symbols": [
                    {"s": "OANDA:XAUUSD", "d": "Gold (XAUUSD)"},
                    {"s": "OANDA:XAGUSD", "d": "Silver (XAGUSD)"},
                    {"s": "TVC:DXY", "d": "DXY"},
                    {"s": "TVC:US10Y", "d": "US10Y"}
                  ],
                  "originalTitle": "Metals & Macro"
                }
              ]
            }
            </script>
          </div>
        </div>
        <p class="small" style="margin:10px 0 0">
          Если виджет не грузится — проверь VPN/блокировки или открой через другой браузер. Это именно «ориентиры», не цена банка.
        </p>
      </div>
    </div>
  </div>

<script>
  const SPOT_API = "https://metals-proxy.analysisswim.workers.dev/api/spot";
  // Временная диагностика (можно потом удалить)
  console.log("SPOT API:", SPOT_API);
  fetch(`${SPOT_API}?symbol=XAUUSD`)
    .then(r => r.text())
    .then(t => console.log("RAW:", t))
    .catch(err => console.error("FETCH ERROR:", err));

  async function fetchSpot(symbol){
    const r = await fetch(`${SPOT_API}?symbol=${encodeURIComponent(symbol)}`);
    if(!r.ok) throw new Error("SPOT_API HTTP " + r.status);
    const data = await r.json();
    return data.price ?? null;
  }

  function fmtUSD(v){
    return "$" + Number(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  async function refresh(){
    const body = document.getElementById("spotBody");
    body.innerHTML = `<tr><td colspan="4"><span class="chip na">обновляю…</span></td></tr>`;
    try{
      const [gold, silver] = await Promise.all([fetchSpot("XAUUSD"), fetchSpot("XAGUSD")]);

      const rows = [
        {name:"Золото (spot)", t:"XAUUSD", price: gold, src:"metals-proxy (Worker)"},
        {name:"Серебро (spot)", t:"XAGUSD", price: silver, src:"metals-proxy (Worker)"}
      ];

      body.innerHTML = rows.map(r => `
        <tr>
          <td>${r.name}</td>
          <td class="mono">${r.t}</td>
          <td class="mono">${r.price ? fmtUSD(r.price) : "—"}</td>
          <td class="small">${r.src}</td>
        </tr>`).join("");

      document.getElementById("ts").textContent = new Date().toLocaleString();
    }catch(e){
      console.error(e);
      body.innerHTML = `<tr><td colspan="4"><span class="chip na">не удалось загрузить spot (проверь Worker)</span></td></tr>`;
    }
  }

  let timer=null;
  function start(intervalMs=60000){
    if(timer) clearInterval(timer);
    refresh();
    timer=setInterval(refresh, intervalMs);
  }

  document.getElementById("refreshBtn").addEventListener("click", refresh);
  start(60000);
</script>
</body>
</html>
