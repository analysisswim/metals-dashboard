<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metals Dashboard — Chart + Signals</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--text:#e7eefc;--muted:#a8b3cf;--up:#3bd671;--down:#ff6b6b;}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1250px;margin:18px auto;padding:0 14px}
    h1{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:12.5px;margin:0 0 14px;line-height:1.45}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: 1.45fr 0.55fr;}}
    .card{background:var(--card);border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:end;justify-content:space-between;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    select,input,button{background:#1b2540;color:var(--text);border:1px solid rgba(255,255,255,.10);border-radius:10px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .box{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .small{font-size:12px;color:var(--muted)}
    .ok{color:var(--up)} .bad{color:var(--down)}
    #chart{height:540px}
    .list{margin:8px 0 0;padding:0;list-style:none;max-height:310px;overflow:auto}
    .list li{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px}
    .list li:last-child{border-bottom:0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
    .buy{background:rgba(59,214,113,.15);color:var(--up)}
    .sell{background:rgba(255,107,107,.15);color:var(--down)}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum" 1}
  </style>

  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Металлы/токены — график + сигналы (MA/RSI/ATR)</h1>
  <p class="sub">
    Данные берём через твой Cloudflare Worker (spot) и, если доступно, свечи (klines). Если klines ещё нет — график возьмётся с CoinGecko автоматически.
    Это инструмент для анализа, не финсовет.
  </p>

  <div class="grid">
    <div class="card">
      <div class="row">
        <div class="row" style="gap:10px;align-items:end">
          <label>
            Актив (график)
            <select id="asset">
              <option value="XAUTUSDT|tether-gold|XAUt (Tether Gold)">XAUt (Tether Gold)</option>
              <option value="BTCUSDT|bitcoin|BTC (test)">BTC (test)</option>
              <option value="ETHUSDT|ethereum|ETH (test)">ETH (test)</option>
            </select>
          </label>

          <label>
            Источник свечей
            <select id="source">
              <option value="worker" selected>Worker (/api/klines) — если есть</option>
              <option value="coingecko">CoinGecko (fallback)</option>
            </select>
          </label>

          <label>
            Таймфрейм
            <select id="tf">
              <option value="15m">15m</option>
              <option value="1h" selected>1h</option>
              <option value="4h">4h</option>
              <option value="1d">1d</option>
            </select>
          </label>

          <label>
            Глубина (баров)
            <select id="limit">
              <option value="200">200</option>
              <option value="500" selected>500</option>
              <option value="1000">1000</option>
            </select>
          </label>

          <label>
            Валюта (для CoinGecko)
            <select id="vs">
              <option value="usd" selected>USD</option>
              <option value="sgd">SGD</option>
            </select>
          </label>
        </div>

        <div class="row" style="gap:8px;align-items:end">
          <button id="loadBtn">Загрузить</button>
          <button id="resetBtn">Сброс</button>
          <span class="small">Обновлено: <span id="ts">—</span></span>
        </div>
      </div>

      <div id="chart" style="margin-top:12px"></div>
      <div class="small" style="margin-top:10px">
        BUY: MAfast пересекает MAslow вверх и RSI &lt; buyRSI. SELL: пересечение вниз и RSI &gt; sellRSI. Stop/TP = ATR×множители.
      </div>
    </div>

    <div class="card">
      <div class="box">
        <b>Spot (через Worker)</b>
        <div class="small" style="margin-top:6px">
          XAUUSD: <span class="mono" id="spotXAU">—</span> • XAGUSD: <span class="mono" id="spotXAG">—</span>
          <div class="small">Источник: <span id="spotSrc">—</span></div>
        </div>
        <button id="spotBtn" style="margin-top:10px">Обновить spot</button>
      </div>

      <div class="box" style="margin-top:10px">
        <b>Параметры стратегии</b>
        <div class="kv">
          <label>MA fast <input id="maFast" type="number" value="9" min="2" step="1"></label>
          <label>MA slow <input id="maSlow" type="number" value="21" min="3" step="1"></label>
          <label>RSI period <input id="rsiLen" type="number" value="14" min="5" step="1"></label>
          <label>ATR period <input id="atrLen" type="number" value="14" min="5" step="1"></label>
          <label>BUY RSI &lt; <input id="buyRsi" type="number" value="55" min="10" max="90" step="1"></label>
          <label>SELL RSI &gt; <input id="sellRsi" type="number" value="65" min="10" max="90" step="1"></label>
          <label>Stop ATR × <input id="atrStop" type="number" value="2" min="0.5" step="0.5"></label>
          <label>TP ATR × <input id="atrTp" type="number" value="3" min="0.5" step="0.5"></label>
        </div>
      </div>

      <div class="box" style="margin-top:10px">
        <div class="row" style="align-items:center">
          <b>Сигналы</b>
          <span class="small">Всего: <span id="sigCount">—</span></span>
        </div>
        <ul class="list" id="signals"></ul>
      </div>

      <div class="box" style="margin-top:10px">
        <b>Состояние</b>
        <div class="small" id="state" style="margin-top:8px">—</div>
      </div>
    </div>
  </div>
</div>

<script>
/** =============================
 *  НАСТРОЙКА: твой Worker URL
 *  ============================= */
const WORKER_BASE = "https://metals-proxy.analysisswim.workers.dev"; // ← твой
const SPOT_ENDPOINT = `${WORKER_BASE}/api/spot`;

/** =============================
 *  УТИЛИТЫ
 *  ============================= */
function fmtTime(ms){
  const d = new Date(ms);
  return d.toLocaleString("ru-RU", { hour12:false });
}
function setState(html){ document.getElementById("state").innerHTML = html; }
function setTS(){ document.getElementById("ts").textContent = new Date().toLocaleString("ru-RU", {hour12:false}); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/** =============================
 *  ИНДИКАТОРЫ
 *  ============================= */
function sma(values, length){
  const out = Array(values.length).fill(null);
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=length) sum -= values[i-length];
    if(i>=length-1) out[i] = sum/length;
  }
  return out;
}
function rsi(values, length){
  const out = Array(values.length).fill(null);
  if(values.length <= length) return out;

  let gain = 0, loss = 0;
  for(let i=1;i<=length;i++){
    const ch = values[i] - values[i-1];
    if(ch>=0) gain += ch; else loss -= ch;
  }
  gain /= length; loss /= length;
  out[length] = loss === 0 ? 100 : 100 - (100/(1 + gain/loss));

  for(let i=length+1;i<values.length;i++){
    const ch = values[i]-values[i-1];
    const g = ch>0 ? ch : 0;
    const l = ch<0 ? -ch : 0;
    gain = (gain*(length-1) + g)/length;
    loss = (loss*(length-1) + l
