<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Металлы/токены — график + сигналы (MA/RSI/ATR)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b;
      --text:#e7eefc; --muted:#a8b3cf;
      --line:rgba(255,255,255,.08); --btn:#1b2540;
      --ok:#3bd671; --bad:#ff6b6b; --warn:#ffd166;
    }
    html,body{
      margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif
    }
    .wrap{max-width:1200px;margin:18px auto;padding:0 14px}
    .title{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.4fr .8fr; gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:16px; padding:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    select,input{
      background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:10px; padding:10px 10px;
      outline:none; min-width:160px
    }
    input{min-width:120px}
    button{
      background:var(--btn); color:#fff; border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; cursor:pointer
    }
    button:hover{filter:brightness(1.08)}
    .small{font-size:12px;color:var(--muted)}
    .kpi{font-variant-numeric:tabular-nums}
    .box{background:rgba(0,0,0,.15); border:1px solid var(--line); border-radius:14px; padding:12px}
    .status-ok{color:var(--ok)} .status-bad{color:var(--bad)} .status-warn{color:var(--warn)}
    #chart{
      width:100%; height:420px; border-radius:14px; background:rgba(0,0,0,.18);
      border:1px solid var(--line); display:block
    }
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;vertical-align:top}
    th{color:#c7d2f0;font-weight:600}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
    .mono{font-variant-numeric:tabular-nums}
    .hr{height:1px;background:rgba(255,255,255,.06);margin:10px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Металлы/токены — график + сигналы (MA/RSI/ATR)</h1>
  <p class="sub">
    Свечи: Worker → CoinGecko агрегация (/api/klines). Spot XAUUSD/XAGUSD: Worker (/api/spot).
    “План перезаходов” строится от MA/ATR и обновляется при загрузке графика.
  </p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row space">
        <div class="row">
          <div>
            <label>Актив (график)</label>
            <select id="asset">
              <option value="pax-gold" selected>PAXG (Pax Gold)</option>
              <option value="tether-gold">XAUt (Tether Gold)</option>
            </select>
          </div>

          <div>
            <label>Таймфрейм</label>
            <select id="interval">
              <option value="15m">15m</option>
              <option value="1h" selected>1h</option>
              <option value="4h">4h</option>
              <option value="1d">1d</option>
            </select>
          </div>

          <div>
            <label>Период (days)</label>
            <select id="days">
              <option value="7">7 дней</option>
              <option value="30" selected>30 дней</option>
              <option value="90">90 дней</option>
              <option value="180">180 дней</option>
              <option value="365">365 дней</option>
            </select>
          </div>

          <div>
            <label>Глубина (баров)</label>
            <select id="limit">
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="365">365</option>
              <option value="800">800</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="loadBtn">Загрузить</button>
          <button id="resetBtn">Сброс</button>
        </div>
      </div>

      <div class="row space" style="margin:10px 0 8px">
        <div class="small">Обновлено: <span id="ts">—</span></div>
        <div class="small">Последняя цена (close): <span id="last" class="kpi">—</span></div>
      </div>

      <canvas id="chart" width="1200" height="420"></canvas>

      <p class="small" style="margin:10px 0 0">
        BUY: MAfast пересекает MAslow вверх и RSI &lt; buyRSI.
        SELL: пересечение вниз и RSI &gt; sellRSI.
        Stop/TP = ATR × множители.
      </p>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div>
            <div style="font-weight:700">Spot (через Worker)</div>
            <div class="small">XAUUSD: <span id="spotXAU" class="kpi">—</span> · XAGUSD: <span id="spotXAG" class="kpi">—</span></div>
            <div class="small">Источник: <span id="spotSrc">—</span></div>
          </div>
          <button id="spotBtn">Обновить spot</button>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">Параметры стратегии</div>
        <div class="row">
          <div><label>MA fast</label><input id="maFast" type="number" value="9" /></div>
          <div><label>MA slow</label><input id="maSlow" type="number" value="21" /></div>
          <div><label>RSI period</label><input id="rsiP" type="number" value="14" /></div>
          <div><label>ATR period</label><input id="atrP" type="number" value="14" /></div>
          <div><label>BUY RSI &lt;</label><input id="buyRSI" type="number" value="55" /></div>
          <div><label>SELL RSI &gt;</label><input id="sellRSI" type="number" value="65" /></div>
          <div><label>Stop ATR ×</label><input id="stopX" type="number" value="2" /></div>
          <div><label>TP ATR ×</label><input id="tpX" type="number" value="3" /></div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <div><label>Re-entry ATR #1</label><input id="re1" type="number" value="1" /></div>
          <div><label>Re-entry ATR #2</label><input id="re2" type="number" value="2" /></div>
          <div class="hint" style="max-width:360px">
            Перезаходы строятся как уровни “от отката”: MAfast, MAslow и ±ATR (по выбранным множителям).
          </div>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div style="font-weight:700">Сигнал</div>
          <div class="small" id="sigMeta">—</div>
        </div>
        <div id="signal" class="kpi" style="margin-top:8px">—</div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">План перезаходов</div>
        <div class="hint" style="margin-bottom:8px">
          Идея: не гнаться за свечой. Если BUY — добор на откате; если SELL — добор на откате вверх.
        </div>
        <div style="max-height:220px;overflow:auto;border-radius:12px">
          <table>
            <thead>
              <tr><th>Уровень</th><th>Цена</th><th>Доля</th><th>Комментарий</th></tr>
            </thead>
            <tbody id="reRows"><tr><td colspan="4" class="small">—</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">План выходов</div>
        <div style="max-height:220px;overflow:auto;border-radius:12px">
          <table>
            <thead>
              <tr><th>Уровень</th><th>Цена</th><th>Доля</th><th>Комментарий</th></tr>
            </thead>
            <tbody id="exRows"><tr><td colspan="4" class="small">—</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">Последние бары (индикаторы)</div>
        <div style="max-height:220px;overflow:auto;border-radius:12px">
          <table>
            <thead><tr>
              <th>Время</th><th>Close</th><th>MAf</th><th>MAs</th><th>RSI</th><th>ATR</th>
            </tr></thead>
            <tbody id="rows"><tr><td colspan="6" class="small">—</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="box">
        <div style="font-weight:700;margin-bottom:6px">Состояние</div>
        <div id="state" class="small">—</div>
      </div>
    </div>
  </div>
</div>

<script>
/** ===== Helpers ===== **/
const $ = (id)=>document.getElementById(id);
const num = (v, d=2)=> (v==null || !isFinite(v)) ? "—" : Number(v).toFixed(d);

function setState(msg, cls=""){
  const el = $("state");
  el.className = "small " + cls;
  el.textContent = msg;
}
function tsToStr(ms){
  const dt = new Date(ms);
  return dt.toLocaleString();
}

/** ===== API endpoints (твой Worker) ===== **/
const BASE_API  = "https://api-metals.analysisswim.workers.dev";
const SPOT_API  = BASE_API + "/api/spot";
const KLINES_API= BASE_API + "/api/klines";

/** ===== Spot ===== **/
async function fetchSpot(symbol){
  const r = await fetch(`${SPOT_API}?symbol=${encodeURIComponent(symbol)}`, { cache:"no-store" });
  const ct = (r.headers.get("content-type") || "");
  if (!ct.includes("application/json")) {
    const raw = await r.text();
    throw new Error("Spot not JSON: " + raw.slice(0,120));
  }
  const data = await r.json();
  if (data?.price == null) throw new Error("Spot missing price");
  return data;
}
async function refreshSpot(){
  $("spotXAU").textContent = "—";
  $("spotXAG").textContent = "—";
  $("spotSrc").textContent = "—";
  try{
    const [xau,xag] = await Promise.all([fetchSpot("XAUUSD"), fetchSpot("XAGUSD")]);
    $("spotXAU").textContent = num(xau.price, 2) + " USD";
    $("spotXAG").textContent = num(xag.price, 3) + " USD";
    $("spotSrc").textContent = xau.source || "—";
  }catch(e){
    $("spotSrc").textContent = "ошибка (см. console)";
    console.error(e);
    setState("Spot ошибка: " + e.message, "status-bad");
  }
}

/** ===== Klines ===== **/
async function fetchKlines(coinId, interval, days, limit){
  const url =
    `${KLINES_API}?market=coingecko&coin=${encodeURIComponent(coinId)}&vs=usd` +
    `&days=${encodeURIComponent(days)}&interval=${encodeURIComponent(interval)}&limit=${encodeURIComponent(limit)}`;

  const r = await fetch(url, { cache:"no-store" });
  const ct = (r.headers.get("content-type") || "");
  if (!ct.includes("application/json")) {
    const raw = await r.text();
    throw new Error("Klines not JSON: " + raw.slice(0,120));
  }
  const data = await r.json();
  if(!data?.ok || !Array.isArray(data?.ohlc) || data.ohlc.length === 0){
    throw new Error(data?.error || "Bad klines payload");
  }
  return data.ohlc; // [ [ts, open, high, low, close], ... ]
}

/** ===== Indicators ===== **/
function SMA(values, period){
  const out = Array(values.length).fill(null);
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=period) sum -= values[i-period];
    if(i>=period-1) out[i] = sum/period;
  }
  return out;
}
function RSI(closes, period){
  const out = Array(closes.length).fill(null);
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    const diff = closes[i]-closes[i-1];
    if(diff>=0) gains += diff; else losses -= diff;
  }
  let avgG = gains/period, avgL = losses/period;
  out[period] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  for(let i=period+1;i<closes.length;i++){
    const diff = closes[i]-closes[i-1];
    const g = diff>0 ? diff : 0;
    const l = diff<0 ? -diff : 0;
    avgG = (avgG*(period-1)+g)/period;
    avgL = (avgL*(period-1)+l)/period;
    out[i] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  }
  return out;
}
function ATR(ohlc, period){
  const out = Array(ohlc.length).fill(null);
  const tr = Array(ohlc.length).fill(null);
  for(let i=0;i<ohlc.length;i++){
    const [,o,h,l,c] = ohlc[i];
    if(i===0){ tr[i]=h-l; continue; }
    const prevClose = ohlc[i-1][4];
    tr[i] = Math.max(h-l, Math.abs(h-prevClose), Math.abs(l-prevClose));
  }
  let sum=0;
  for(let i=0;i<ohlc.length;i++){
    if(tr[i]==null) continue;
    sum += tr[i];
    if(i>=period) sum -= tr[i-period];
    if(i>=period-1) out[i]=sum/period;
  }
  return out;
}

/** ===== Build plan (re-entries + exits) ===== **/
function buildPlans({signal, lastClose, maF_last, maS_last, atrLast, stopX, tpX, re1, re2}){
  // доли — можно потом сделать настраиваемыми
  const reShares = ["40%", "35%", "25%"]; // 3 добора (MAf/MAslow/ATR2)
  const exShares = ["40%", "35%", "25%"]; // 3 фиксации

  const re = [];
  const ex = [];

  if(!atrLast || !isFinite(atrLast) || !isFinite(lastClose)){
    return { re, ex, levels: [] };
  }

  // exits
  const stop = signal === "SELL"
    ? lastClose + atrLast*stopX
    : lastClose - atrLast*stopX;

  const tp1 = signal === "SELL"
    ? lastClose - atrLast*1
    : lastClose + atrLast*1;

  const tp2 = signal === "SELL"
    ? lastClose - atrLast*2
    : lastClose + atrLast*2;

  const tp3 = signal === "SELL"
    ? lastClose - atrLast*tpX
    : lastClose + atrLast*tpX;

  ex.push({name:"STOP", price:stop, share:"—", note:`Защита (ATR×${stopX})`});
  ex.push({name:"TP1",  price:tp1,  share:exShares[0], note:"Первая фиксация (≈1 ATR)"});
  ex.push({name:"TP2",  price:tp2,  share:exShares[1], note:"Вторая фиксация (≈2 ATR)"});
  ex.push({name:"TP3",  price:tp3,  share:exShares[2], note:`Третья фиксация (ATR×${tpX})`});

  // re-entries
  // BUY: доборы ниже, SELL: доборы выше
  const reA = signal === "SELL" ? (maF_last ?? null) : (maF_last ?? null);
  const reB = signal === "SELL" ? (maS_last ?? null) : (maS_last ?? null);

  const reC = signal === "SELL"
    ? lastClose + atrLast*re1
    : lastClose - atrLast*re1;

  const reD = signal === "SELL"
    ? lastClose + atrLast*re2
    : lastClose - atrLast*re2;

  // Если сигнал не BUY/SELL — всё равно покажем “план”, но пометим
  const noteDir = signal === "SELL"
    ? "SELL: добор на откате вверх"
    : "BUY: добор на откате вниз";

  if(reA!=null) re.push({name:"RE1 (MA fast)", price:reA, share:reShares[0], note:`Откат к MAfast. ${noteDir}`});
  if(reB!=null) re.push({name:"RE2 (MA slow)", price:reB, share:reShares[1], note:`Откат к MAslow. ${noteDir}`});
  re.push({name:`RE3 (ATR×${re1})`, price:reC, share:reShares[2], note:`Глубокий откат по ATR. ${noteDir}`});
  re.push({name:`RE4 (ATR×${re2})`, price:reD, share:"по ситуации", note:`Очень глубокий откат. Лучше уменьшать долю.`});

  // линии на график
  const levels = [
    {label:"ENTRY", v:lastClose},
    {label:"MAf",   v:maF_last},
    {label:"MAs",   v:maS_last},
    {label:"STOP",  v:stop},
    {label:"TP1",   v:tp1},
    {label:"TP2",   v:tp2},
    {label:"TP3",   v:tp3},
    {label:"RE1",   v:reA},
    {label:"RE2",   v:reB},
    {label:"RE3",   v:reC},
    {label:"RE4",   v:reD},
  ].filter(x => x.v!=null && isFinite(x.v));

  return { re, ex, levels };
}

function renderPlanRows(tbodyId, items){
  const tb = $(tbodyId);
  if(!items || items.length===0){
    tb.innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    return;
  }
  tb.innerHTML = items.map(x => `
    <tr>
      <td><span class="pill mono">${x.name}</span></td>
      <td class="mono">${num(x.price,2)}</td>
      <td>${x.share || "—"}</td>
      <td class="small">${x.note || ""}</td>
    </tr>
  `).join("");
}

/** ===== Chart ===== **/
function drawChart(canvas, candles, maF, maS, extraLevels=[]){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const padL=50, padR=20, padT=18, padB=28;
  const plotW = w-padL-padR, plotH=h-padT-padB;

  const closes = candles.map(x=>x[4]);
  const minP = Math.min(...closes), maxP = Math.max(...closes);

  // расширим диапазон под уровни (stop/tp)
  const levelVals = extraLevels.map(x=>x.v);
  const minL = levelVals.length ? Math.min(...levelVals) : minP;
  const maxL = levelVals.length ? Math.max(...levelVals) : maxP;
  const min = Math.min(minP, minL);
  const max = Math.max(maxP, maxL);

  const y = (v)=> padT + (max-v)/(max-min||1)*plotH;
  const x = (i)=> padL + (i/(candles.length-1||1))*plotW;

  // grid
  ctx.globalAlpha=0.5;
  ctx.strokeStyle="rgba(255,255,255,.08)";
  for(let i=0;i<=4;i++){
    const yy = padT + (i/4)*plotH;
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy); ctx.stroke();
  }
  ctx.globalAlpha=1;

  // extra horizontal levels
  ctx.lineWidth = 1;
  for(const lv of extraLevels){
    const yy = y(lv.v);
    ctx.strokeStyle = "rgba(255,255,255,.20)";
    if(lv.label==="STOP") ctx.strokeStyle = "rgba(255,107,107,.55)";
    if(lv.label.startsWith("TP")) ctx.strokeStyle = "rgba(59,214,113,.45)";
    if(lv.label.startsWith("RE")) ctx.strokeStyle = "rgba(255,209,102,.35)";
    if(lv.label==="ENTRY") ctx.strokeStyle = "rgba(168,179,207,.45)";
    if(lv.label==="MAf") ctx.strokeStyle = "rgba(59,214,113,.30)";
    if(lv.label==="MAs") ctx.strokeStyle = "rgba(255,107,107,.30)";

    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(padL, yy);
    ctx.lineTo(w-padR, yy);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle="rgba(168,179,207,1)";
    ctx.font="11px system-ui";
    ctx.fillText(`${lv.label}: ${num(lv.v,2)}`, padL+6, yy-4);
  }

  // price
  ctx.strokeStyle="rgba(255,255,255,.85)";
  ctx.lineWidth=1.2;
  ctx.beginPath();
  closes.forEach((c,i)=>{ const xx=x(i), yy=y(c); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); });
  ctx.stroke();

  // MA fast (green)
  ctx.strokeStyle="rgba(59,214,113,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  let startedF=false;
  maF.forEach((v,i)=>{
    if(v==null) return;
    const xx=x(i), yy=y(v);
    if(!startedF){ ctx.moveTo(xx,yy); startedF=true; } else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // MA slow (red)
  ctx.strokeStyle="rgba(255,107,107,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  let startedS=false;
  maS.forEach((v,i)=>{
    if(v==null) return;
    const xx=x(i), yy=y(v);
    if(!startedS){ ctx.moveTo(xx,yy); startedS=true; } else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // labels
  ctx.fillStyle="rgba(168,179,207,1)";
  ctx.font="12px system-ui";
  ctx.fillText(num(max,2), 8, padT+10);
  ctx.fillText(num(min,2), 8, padT+plotH);
}

/** ===== Main flow ===== **/
async function loadAll(){
  setState("Загружаю свечи…", "status-warn");
  $("rows").innerHTML = `<tr><td colspan="6" class="small">загрузка…</td></tr>`;
  $("signal").textContent = "—";
  $("sigMeta").textContent = "—";
  $("reRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
  $("exRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;

  const coinId = $("asset").value;
  const interval = $("interval").value;
  const days = Number($("days").value);
  const limit = Number($("limit").value);

  const maFast = Math.max(2, Number($("maFast").value||9));
  const maSlow = Math.max(maFast+1, Number($("maSlow").value||21));
  const rsiP = Math.max(2, Number($("rsiP").value||14));
  const atrP = Math.max(2, Number($("atrP").value||14));
  const buyRSI = Number($("buyRSI").value||55);
  const sellRSI = Number($("sellRSI").value||65);
  const stopX = Number($("stopX").value||2);
  const tpX = Number($("tpX").value||3);
  const re1 = Number($("re1").value||1);
  const re2 = Number($("re2").value||2);

  try{
    const ohlc = await fetchKlines(coinId, interval, days, limit);

    const closes = ohlc.map(x=>x[4]);
    const maF = SMA(closes, maFast);
    const maS = SMA(closes, maSlow);
    const rsi = RSI(closes, rsiP);
    const atr = ATR(ohlc, atrP);

    const lastIdx = ohlc.length-1;
    const lastClose = closes[lastIdx];
    $("last").textContent = num(lastClose,2) + " USD";
    $("ts").textContent = new Date().toLocaleString();

    // signal
    let signal = "NEUTRAL";
    const prev = lastIdx-1;

    const crossUp = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] <= maS[prev]) && (maF[lastIdx] > maS[lastIdx]);

    const crossDn = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] >= maS[prev]) && (maF[lastIdx] < maS[lastIdx]);

    const rsiLast = rsi[lastIdx];
    const atrLast = atr[lastIdx];

    if(crossUp && rsiLast!=null && rsiLast < buyRSI){
      signal = "BUY";
    } else if(crossDn && rsiLast!=null && rsiLast > sellRSI){
      signal = "SELL";
    }

    $("sigMeta").textContent = `${coinId} • ${interval} • days=${days} • bars=${ohlc.length}`;
    $("signal").textContent =
      `Сигнал: ${signal} · Close=${num(lastClose,2)} · RSI=${num(rsiLast,1)} · ATR=${num(atrLast,2)}`;

    // plans
    const maF_last = maF[lastIdx];
    const maS_last = maS[lastIdx];

    const {re, ex, levels} = buildPlans({
      signal, lastClose, maF_last, maS_last, atrLast,
      stopX, tpX, re1, re2
    });

    renderPlanRows("reRows", re);
    renderPlanRows("exRows", ex);

    // table (last 12)
    const rows = [];
    for(let i=Math.max(0,lastIdx-11); i<=lastIdx; i++){
      rows.push(`
        <tr>
          <td>${tsToStr(ohlc[i][0])}</td>
          <td>${num(closes[i],2)}</td>
          <td>${num(maF[i],2)}</td>
          <td>${num(maS[i],2)}</td>
          <td>${num(rsi[i],1)}</td>
          <td>${num(atr[i],2)}</td>
        </tr>
      `);
    }
    $("rows").innerHTML = rows.join("");

    drawChart($("chart"), ohlc, maF, maS, levels);

    setState("OK: свечи загружены через Worker (CoinGecko агрегация)", "status-ok");
  }catch(e){
    console.error(e);
    setState("Ошибка загрузки: " + e.message, "status-bad");
    $("rows").innerHTML = `<tr><td colspan="6" class="small">—</td></tr>`;
    $("reRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    $("exRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    const ctx = $("chart").getContext("2d");
    ctx.clearRect(0,0,$("chart").width,$("chart").height);
  }
}

function resetUI(){
  $("ts").textContent = "—";
  $("last").textContent = "—";
  $("signal").textContent = "—";
  $("sigMeta").textContent = "—";
  $("rows").innerHTML = `<tr><td colspan="6" class="small">—</td></tr>`;
  $("reRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
  $("exRows").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
  const ctx = $("chart").getContext("2d");
  ctx.clearRect(0,0,$("chart").width,$("chart").height);
  setState("Сброшено", "");
}

$("loadBtn").addEventListener("click", loadAll);
$("resetBtn").addEventListener("click", resetUI);
$("spotBtn").addEventListener("click", refreshSpot);

// старт
resetUI();
refreshSpot();
loadAll();
</script>
</body>
</html>
