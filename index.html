<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gold/Silver Dashboard — график + сигналы + PnL</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#a8b3cf;
      --line:rgba(255,255,255,.08); --btn:#1b2540;
      --ok:#3bd671; --bad:#ff6b6b; --warn:#ffd166;
      --card:rgba(255,255,255,.03);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1220px;margin:18px auto;padding:0 14px}
    .title{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.35fr .85fr; gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, var(--card), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:16px; padding:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.35)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    select,input{
      background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:10px; padding:10px 10px;
      outline:none; min-width:160px
    }
    input{min-width:120px}
    button{
      background:var(--btn); color:#fff; border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; cursor:pointer
    }
    button:hover{filter:brightness(1.08)}
    .small{font-size:12px;color:var(--muted)}
    .kpi{font-variant-numeric:tabular-nums}
    .box{background:rgba(0,0,0,.15); border:1px solid var(--line); border-radius:14px; padding:12px}
    .status-ok{color:var(--ok)} .status-bad{color:var(--bad)} .status-warn{color:var(--warn)}
    #chart{width:100%; height:420px; border-radius:14px; background:rgba(0,0,0,.18);
      border:1px solid var(--line); display:block}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#c7d2f0;font-weight:600}
    .pill{display:inline-block;padding:3px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h1 class="title">Gold/Silver Dashboard — график + сигналы + PnL</h1>
  <p class="sub">
    Spot XAU/XAG берём через твой Worker (<b>/api/summary</b>), графики берём через <b>/api/klines</b> (основной: Kraken).
    CoinGecko может давать <b>429</b> — это лимит, не твоя ошибка.
  </p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row space">
        <div class="row">
          <div>
            <label>Актив (график)</label>
            <select id="asset">
              <option value="PAXGUSD">PAXGUSD (Kraken)</option>
              <option value="XAUTUSD">XAUTUSD (Kraken)</option>
            </select>
          </div>
          <div>
            <label>Days</label>
            <select id="days">
              <option value="7">7</option>
              <option value="30" selected>30</option>
              <option value="90">90</option>
              <option value="180">180</option>
            </select>
          </div>
          <div>
            <label>Interval (мин)</label>
            <select id="interval">
              <option value="15">15</option>
              <option value="60" selected>60</option>
              <option value="240">240</option>
              <option value="1440">1440 (1D)</option>
            </select>
          </div>
          <div>
            <label>Limit</label>
            <select id="limit">
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="365">365</option>
              <option value="720">720</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button id="loadBtn">Загрузить</button>
          <button id="resetBtn">Сброс</button>
        </div>
      </div>

      <div class="row space" style="margin:10px 0 8px">
        <div class="small">Обновлено: <span id="ts">—</span></div>
        <div class="small">Последняя цена: <span id="last" class="kpi">—</span></div>
      </div>

      <canvas id="chart" width="1200" height="420"></canvas>

      <p class="small" style="margin:10px 0 0">
        Сигнал: MAfast/MAslow + RSI фильтр, стоп/TP по ATR. Это “подсказка”, не гарантия.
      </p>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div>
            <div style="font-weight:700">Spot (через Worker summary)</div>
            <div class="small">
              XAUUSD: <span id="spotXAU" class="kpi">—</span>
              <span class="pill" id="spotXAUsgd">—</span>
            </div>
            <div class="small">
              XAGUSD: <span id="spotXAG" class="kpi">—</span>
              <span class="pill" id="spotXAGsgd">—</span>
            </div>
            <div class="small">GSR (Gold/Silver): <span id="gsr" class="kpi">—</span></div>
            <div class="small">FX USD→SGD: <span id="fx" class="kpi">—</span> · Источник: <span id="spotSrc">—</span></div>
          </div>
          <button id="spotBtn">Обновить</button>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">Параметры стратегии</div>
        <div class="row">
          <div><label>MA fast</label><input id="maFast" type="number" value="9" /></div>
          <div><label>MA slow</label><input id="maSlow" type="number" value="21" /></div>
          <div><label>RSI period</label><input id="rsiP" type="number" value="14" /></div>
          <div><label>ATR period</label><input id="atrP" type="number" value="14" /></div>
          <div><label>BUY RSI &lt;</label><input id="buyRSI" type="number" value="55" /></div>
          <div><label>SELL RSI &gt;</label><input id="sellRSI" type="number" value="65" /></div>
          <div><label>Stop ATR ×</label><input id="stopX" type="number" value="2" /></div>
          <div><label>TP ATR ×</label><input id="tpX" type="number" value="3" /></div>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div style="font-weight:700">Сигнал</div>
          <div class="small">—</div>
        </div>
        <div id="signal" class="kpi" style="margin-top:8px">—</div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">Сделки (PnL)</div>
        <div class="small">Введи покупки/продажи (цена и количество). Считаем PnL по FIFO. Сохраняется в браузере.</div>
        <div class="row" style="margin-top:10px">
          <select id="side">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
          </select>
          <input id="tPrice" type="number" step="0.0001" placeholder="Price" />
          <input id="tQty" type="number" step="0.0001" placeholder="Qty" />
          <button id="addTrade">Добавить</button>
          <button id="clearTrades">Очистить</button>
        </div>
        <div style="max-height:160px;overflow:auto;border-radius:12px;margin-top:10px">
          <table>
            <thead><tr><th>#</th><th>Side</th><th>Price</th><th>Qty</th></tr></thead>
            <tbody id="tradesBody"><tr><td colspan="4" class="small">—</td></tr></tbody>
          </table>
        </div>
        <div class="row space" style="margin-top:10px">
          <div class="small">Остаток позиции: <span id="posLeft" class="kpi">—</span></div>
          <div class="small">PnL (realized): <span id="pnl" class="kpi">—</span></div>
        </div>
      </div>

      <div class="box">
        <div style="font-weight:700;margin-bottom:6px">Состояние</div>
        <div id="state" class="small">—</div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const num = (v, d=2)=> (v==null || !isFinite(v)) ? "—" : Number(v).toFixed(d);

function setState(msg, cls=""){
  const el = $("state");
  el.className = "small " + cls;
  el.textContent = msg;
}
function tsToStr(ms){ return new Date(ms).toLocaleString(); }

// ==== ТВОЙ Worker домен ====
const API_BASE = "https://api-metals.analysisswim.workers.dev";

// --------------------
// Spot + FX + Ratio
// --------------------
async function refreshSummary(){
  setState("Обновляю spot/fx…", "status-warn");
  try{
    const r = await fetch(`${API_BASE}/api/summary?to=SGD`, { cache:"no-store" });
    const ct = (r.headers.get("content-type")||"");
    if(!ct.includes("application/json")) throw new Error("summary not JSON");
    const data = await r.json();
    if(!data.ok) throw new Error(data.error || "summary error");

    const xau = data?.spot?.XAUUSD;
    const xag = data?.spot?.XAGUSD;
    const gsr = data?.spot?.GSR;

    $("spotXAU").textContent = num(xau,2) + " USD";
    $("spotXAG").textContent = num(xag,3) + " USD";
    $("gsr").textContent = num(gsr,2);

    const fx = data?.fx?.rate;
    $("fx").textContent = fx ? ("1 USD = " + num(fx,4) + " SGD") : "—";
    $("spotSrc").textContent = data?.spot?.source || "—";

    if(fx){
      $("spotXAUsgd").textContent = num(xau*fx,2) + " SGD";
      $("spotXAGsgd").textContent = num(xag*fx,3) + " SGD";
    } else {
      $("spotXAUsgd").textContent = "—";
      $("spotXAGsgd").textContent = "—";
    }

    setState("OK: spot/fx обновлены", "status-ok");
  }catch(e){
    console.error(e);
    setState("Spot/Fx ошибка: " + e.message, "status-bad");
  }
}

// --------------------
// Klines (Kraken)
// --------------------
async function fetchKlinesKraken(pair, days=30, interval=60, limit=200){
  const url =
    `${API_BASE}/api/klines?market=kraken` +
    `&pair=${encodeURIComponent(pair)}` +
    `&days=${encodeURIComponent(days)}` +
    `&interval=${encodeURIComponent(interval)}` +
    `&limit=${encodeURIComponent(limit)}`;

  const r = await fetch(url, { cache:"no-store" });
  const ct = (r.headers.get("content-type") || "");
  if(!ct.includes("application/json")){
    const raw = await r.text();
    throw new Error("Bad klines (not JSON): " + raw.slice(0,160));
  }
  const data = await r.json();
  if(!Array.isArray(data) || data.length===0 || !Array.isArray(data[0])){
    throw new Error("Bad klines payload");
  }
  return data; // [[ts,o,h,l,c],...]
}

// --------------------
// Indicators
// --------------------
function SMA(values, period){
  const out = Array(values.length).fill(null);
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=period) sum -= values[i-period];
    if(i>=period-1) out[i] = sum/period;
  }
  return out;
}
function RSI(closes, period){
  const out = Array(closes.length).fill(null);
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    const diff = closes[i]-closes[i-1];
    if(diff>=0) gains += diff; else losses -= diff;
  }
  let avgG = gains/period, avgL = losses/period;
  out[period] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  for(let i=period+1;i<closes.length;i++){
    const diff = closes[i]-closes[i-1];
    const g = diff>0 ? diff : 0;
    const l = diff<0 ? -diff : 0;
    avgG = (avgG*(period-1)+g)/period;
    avgL = (avgL*(period-1)+l)/period;
    out[i] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  }
  return out;
}
function ATR(ohlc, period){
  const out = Array(ohlc.length).fill(null);
  const tr = Array(ohlc.length).fill(null);
  for(let i=0;i<ohlc.length;i++){
    const [, ,h,l,] = ohlc[i];
    if(i===0){ tr[i]=h-l; continue; }
    const prevClose = ohlc[i-1][4];
    tr[i] = Math.max(h-l, Math.abs(h-prevClose), Math.abs(l-prevClose));
  }
  let sum=0;
  for(let i=0;i<ohlc.length;i++){
    sum += tr[i];
    if(i>=period) sum -= tr[i-period];
    if(i>=period-1) out[i]=sum/period;
  }
  return out;
}

// --------------------
// Chart (canvas)
—function drawChart(canvas, candles, maF, maS){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const padL=50, padR=20, padT=18, padB=28;
  const plotW = w-padL-padR, plotH=h-padT-padB;

  const closes = candles.map(x=>x[4]);
  const min = Math.min(...closes), max=Math.max(...closes);
  const y = (v)=> padT + (max-v)/(max-min||1)*plotH;
  const x = (i)=> padL + (i/(candles.length-1||1))*plotW;

  ctx.globalAlpha=0.5;
  ctx.strokeStyle="rgba(255,255,255,.08)";
  for(let i=0;i<=4;i++){
    const yy = padT + (i/4)*plotH;
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy); ctx.stroke();
  }
  ctx.globalAlpha=1;

  ctx.strokeStyle="rgba(255,255,255,.85)";
  ctx.lineWidth=1.2;
  ctx.beginPath();
  closes.forEach((c,i)=>{ const xx=x(i), yy=y(c); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); });
  ctx.stroke();

  ctx.strokeStyle="rgba(59,214,113,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  let startedF=false;
  maF.forEach((v,i)=>{ if(v==null) return; const xx=x(i), yy=y(v); if(!startedF){ctx.moveTo(xx,yy); startedF=true;} else ctx.lineTo(xx,yy); });
  ctx.stroke();

  ctx.strokeStyle="rgba(255,107,107,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  let startedS=false;
  maS.forEach((v,i)=>{ if(v==null) return; const xx=x(i), yy=y(v); if(!startedS){ctx.moveTo(xx,yy); startedS=true;} else ctx.lineTo(xx,yy); });
  ctx.stroke();

  ctx.fillStyle="rgba(168,179,207,1)";
  ctx.font="12px system-ui";
  ctx.fillText(num(max,2), 8, padT+10);
  ctx.fillText(num(min,2), 8, padT+plotH);
}

// --------------------
// Main Load
// --------------------
async function loadAll(){
  setState("Загружаю klines (Kraken)…", "status-warn");

  const pair = $("asset").value; // PAXGUSD / XAUTUSD
  const days = Number($("days").value);
  const limit = Number($("limit").value);
  const interval = Number($("interval").value);

  const maFast = Math.max(2, Number($("maFast").value||9));
  const maSlow = Math.max(maFast+1, Number($("maSlow").value||21));
  const rsiP = Math.max(2, Number($("rsiP").value||14));
  const atrP = Math.max(2, Number($("atrP").value||14));
  const buyRSI = Number($("buyRSI").value||55);
  const sellRSI = Number($("sellRSI").value||65);
  const stopX = Number($("stopX").value||2);
  const tpX = Number($("tpX").value||3);

  try{
    const ohlc = await fetchKlinesKraken(pair, days, interval, limit);

    const closes = ohlc.map(x=>x[4]);
    const maF = SMA(closes, maFast);
    const maS = SMA(closes, maSlow);
    const rsi = RSI(closes, rsiP);
    const atr = ATR(ohlc, atrP);

    const lastIdx = ohlc.length-1;
    const lastClose = closes[lastIdx];
    $("last").textContent = num(lastClose,2) + " USD";
    $("ts").textContent = new Date().toLocaleString();

    const prev = lastIdx-1;
    const crossUp = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] <= maS[prev]) && (maF[lastIdx] > maS[lastIdx]);
    const crossDn = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] >= maS[prev]) && (maF[lastIdx] < maS[lastIdx]);

    const rsiLast = rsi[lastIdx];
    const atrLast = atr[lastIdx];

    let signal = "NEUTRAL", stop=null, tp=null;
    if(crossUp && rsiLast!=null && rsiLast < buyRSI){
      signal="BUY";
      if(atrLast!=null){ stop=lastClose-atrLast*stopX; tp=lastClose+atrLast*tpX; }
    } else if(crossDn && rsiLast!=null && rsiLast > sellRSI){
      signal="SELL";
      if(atrLast!=null){ stop=lastClose+atrLast*stopX; tp=lastClose-atrLast*tpX; }
    }

    $("signal").textContent =
      `Сигнал: ${signal} · Close=${num(lastClose,2)} · RSI=${num(rsiLast,1)} · Stop≈${num(stop,2)} · TP≈${num(tp,2)} (ATR=${num(atrLast,2)})`;

    drawChart($("chart"), ohlc, maF, maS);
    setState("OK: klines получены (Kraken)", "status-ok");
  }catch(e){
    console.error(e);
    setState("Ошибка klines: " + e.message, "status-bad");
    $("signal").textContent = "—";
  }
}

function resetUI(){
  $("ts").textContent = "—";
  $("last").textContent = "—";
  $("signal").textContent = "—";
  const ctx = $("chart").getContext("2d");
  ctx.clearRect(0,0,$("chart").width,$("chart").height);
  setState("Сброшено", "");
}

// --------------------
// Trades PnL (FIFO) + localStorage
// --------------------
const LS_KEY = "metals_trades_v1";
function loadTrades(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(_){ return []; }
}
function saveTrades(t){ localStorage.setItem(LS_KEY, JSON.stringify(t)); }

function renderTrades(){
  const trades = loadTrades();
  if(!trades.length){
    $("tradesBody").innerHTML = `<tr><td colspan="4" class="small">—</td></tr>`;
    $("posLeft").textContent = "—";
    $("pnl").textContent = "—";
    return;
  }
  $("tradesBody").innerHTML = trades.map((t,i)=>`
    <tr><td>${i+1}</td><td>${t.side}</td><td>${Number(t.price).toFixed(4)}</td><td>${Number(t.qty).toFixed(4)}</td></tr>
  `).join("");

  // FIFO calc
  const lots = [];
  let realized = 0;
  for(const t of trades){
    const p = Number(t.price), q = Number(t.qty);
    if(t.side==="BUY"){
      lots.push({price:p, qty:q});
    } else {
      let sellQty = q;
      while(sellQty>1e-12 && lots.length){
        const lot = lots[0];
        const used = Math.min(lot.qty, sellQty);
        realized += (p - lot.price) * used;
        lot.qty -= used;
        sellQty -= used;
        if(lot.qty<=1e-12) lots.shift();
      }
    }
  }
  const left = lots.reduce((a,b)=>a+b.qty,0);
  $("posLeft").textContent = left.toFixed(4);
  $("pnl").textContent = realized.toFixed(2) + " USD";
}

$("addTrade").addEventListener("click", ()=>{
  const side = $("side").value;
  const price = Number($("tPrice").value);
  const qty = Number($("tQty").value);
  if(!Number.isFinite(price) || !Number.isFinite(qty) || qty<=0) return;

  const trades = loadTrades();
  trades.push({side, price, qty});
  saveTrades(trades);
  $("tPrice").value = "";
  $("tQty").value = "";
  renderTrades();
});

$("clearTrades").addEventListener("click", ()=>{
  saveTrades([]);
  renderTrades();
});

// --------------------
$("loadBtn").addEventListener("click", loadAll);
$("resetBtn").addEventListener("click", resetUI);
$("spotBtn").addEventListener("click", refreshSummary);

// старт
resetUI();
refreshSummary();
renderTrades();
</script>
</body>
</html>
