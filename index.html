<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ú–µ—Ç–∞–ª–ª—ã ‚Äî –≥—Ä–∞—Ñ–∏–∫ + —Å–∏–≥–Ω–∞–ª—ã (MA/RSI/ATR)</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e7eefc; --muted:#a8b3cf;
      --line:rgba(255,255,255,.08); --btn:#1b2540;
      --ok:#3bd671; --bad:#ff6b6b; --warn:#ffd166;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1280px;margin:18px auto;padding:0 14px}
    .title{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);font-size:13px;margin:0 0 14px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.55fr .85fr; gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow:0 12px 40px rgba(0,0,0,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row.space{justify-content:space-between}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    select,input{
      background:rgba(255,255,255,.03); color:var(--text);
      border:1px solid var(--line); border-radius:10px; padding:10px 10px;
      outline:none; min-width:160px
    }
    input{min-width:120px}
    button{
      background:var(--btn); color:#fff; border:1px solid var(--line);
      border-radius:12px; padding:10px 12px; cursor:pointer
    }
    button:hover{filter:brightness(1.08)}
    .small{font-size:12px;color:var(--muted)}
    .kpi{font-variant-numeric:tabular-nums}
    .box{background:rgba(0,0,0,.15); border:1px solid var(--line); border-radius:14px; padding:12px}
    .status-ok{color:var(--ok)} .status-bad{color:var(--bad)} .status-warn{color:var(--warn)}
    #chartWrap{position:relative}
    #chart{width:100%; height:440px; border-radius:14px; background:rgba(0,0,0,.18);
      border:1px solid var(--line); display:block}
    #tip{
      position:absolute; top:10px; left:10px;
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.14);
      padding:8px 10px; border-radius:12px; font-size:12px; color:#e7eefc;
      pointer-events:none; display:none; max-width:320px
    }
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    th{color:#c7d2f0;font-weight:600}
  </style>
</head>
<body>
<div class="wrap">
  <h1 class="title">–ú–µ—Ç–∞–ª–ª—ã ‚Äî –≥—Ä–∞—Ñ–∏–∫ + —Å–∏–≥–Ω–∞–ª—ã (MA/RSI/ATR)</h1>
  <p class="sub">
    –°–≤–µ—á–∏ –±–µ—Ä—ë–º —á–µ—Ä–µ–∑ —Ç–≤–æ–π Cloudflare Worker <b>/api/klines</b> (Kraken, —Å –∞–≤—Ç–æ-–ø–æ–∏—Å–∫–æ–º –ø–∞—Ä—ã).
    Spot XAUUSD/XAGUSD ‚Äî —á–µ—Ä–µ–∑ <b>/api/spot</b>.
    –í–∞–ª—é—Ç–∞: USD/SGD ‚Äî —á–µ—Ä–µ–∑ <b>/api/fx</b>. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –≥—Ä—É–∑–∏—Ç—Å—è ‚Äî —Å–º–æ—Ç—Ä–∏ ‚Äú–°–æ—Å—Ç–æ—è–Ω–∏–µ‚Äù.
  </p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row space">
        <div class="row">
          <div>
            <label>–ê–∫—Ç–∏–≤ (–≥—Ä–∞—Ñ–∏–∫)</label>
            <select id="asset">
              <option value="PAXGUSD">PAXGUSD (Kraken)</option>
              <option value="XAUTUSD">XAUTUSD (Kraken)</option>
              <option value="XAUUSD">XAUUSD (Gold)</option>
              <option value="XAGUSD">XAGUSD (Silver)</option>
            </select>
          </div>

          <div>
            <label>–í–∞–ª—é—Ç–∞</label>
            <select id="ccy">
              <option value="USD" selected>USD</option>
              <option value="SGD">SGD</option>
            </select>
          </div>

          <div>
            <label>–¢–∞–π–º—Ñ—Ä–µ–π–º (days)</label>
            <select id="days">
              <option value="7">7 –¥–Ω–µ–π</option>
              <option value="30" selected>30 –¥–Ω–µ–π</option>
              <option value="90">90 –¥–Ω–µ–π</option>
              <option value="180">180 –¥–Ω–µ–π</option>
              <option value="365">365 –¥–Ω–µ–π</option>
            </select>
          </div>

          <div>
            <label>–ì–ª—É–±–∏–Ω–∞ (–±–∞—Ä–æ–≤)</label>
            <select id="limit">
              <option value="100">100</option>
              <option value="200" selected>200</option>
              <option value="365">365</option>
              <option value="720">720</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          <button id="resetBtn">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="row space" style="margin:10px 0 8px">
        <div class="small">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="ts">‚Äî</span></div>
        <div class="small">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ü–µ–Ω–∞: <span id="last" class="kpi">‚Äî</span></div>
      </div>

      <div id="chartWrap">
        <canvas id="chart" width="1400" height="440"></canvas>
        <div id="tip"></div>
      </div>

      <p class="small" style="margin:10px 0 0">
        BUY: MAfast –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç MAslow –≤–≤–µ—Ä—Ö –∏ RSI &lt; buyRSI. SELL: –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤–Ω–∏–∑ –∏ RSI &gt; sellRSI.
        Stop/TP = ATR √ó –º–Ω–æ–∂–∏—Ç–µ–ª–∏.
      </p>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div>
            <div style="font-weight:700">Spot (—á–µ—Ä–µ–∑ Worker)</div>
            <div class="small">
              XAUUSD: <span id="spotXAU" class="kpi">‚Äî</span> ¬∑
              XAGUSD: <span id="spotXAG" class="kpi">‚Äî</span>
            </div>
            <div class="small">Gold/Silver ratio: <span id="ratio" class="kpi">‚Äî</span></div>
            <div class="small">–ò—Å—Ç–æ—á–Ω–∏–∫: <span id="spotSrc">‚Äî</span></div>
          </div>
          <button id="spotBtn">–û–±–Ω–æ–≤–∏—Ç—å spot</button>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div style="font-weight:700">FX</div>
          <div class="small">USD‚ÜíSGD: <span id="fx" class="kpi">‚Äî</span></div>
        </div>
        <div class="small" style="margin-top:6px;color:var(--muted)">
          (–î–ª—è SGD –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É/stop/tp)
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</div>
        <div class="row">
          <div><label>MA fast</label><input id="maFast" type="number" value="9" /></div>
          <div><label>MA slow</label><input id="maSlow" type="number" value="21" /></div>
          <div><label>RSI period</label><input id="rsiP" type="number" value="14" /></div>
          <div><label>ATR period</label><input id="atrP" type="number" value="14" /></div>
          <div><label>BUY RSI &lt;</label><input id="buyRSI" type="number" value="55" /></div>
          <div><label>SELL RSI &gt;</label><input id="sellRSI" type="number" value="65" /></div>
          <div><label>Stop ATR √ó</label><input id="stopX" type="number" value="2" /></div>
          <div><label>TP ATR √ó</label><input id="tpX" type="number" value="3" /></div>
        </div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div class="row space">
          <div style="font-weight:700">–°–∏–≥–Ω–∞–ª</div>
          <div class="small">‚Äî</div>
        </div>
        <div id="signal" class="kpi" style="margin-top:8px">‚Äî</div>
      </div>

      <div class="box" style="margin-bottom:12px">
        <div style="font-weight:700;margin-bottom:8px">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –±–∞—Ä—ã (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã)</div>
        <div style="max-height:240px;overflow:auto;border-radius:12px">
          <table>
            <thead><tr>
              <th>–í—Ä–µ–º—è</th><th>Close</th><th>MAf</th><th>MAs</th><th>RSI</th><th>ATR</th>
            </tr></thead>
            <tbody id="rows"><tr><td colspan="6" class="small">‚Äî</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="box">
        <div style="font-weight:700;margin-bottom:6px">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div>
        <div id="state" class="small">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const num = (v, d=2)=> (v==null || !isFinite(v)) ? "‚Äî" : Number(v).toFixed(d);

function setState(msg, cls=""){
  const el = $("state");
  el.className = "small " + cls;
  el.textContent = msg;
}
function tsToStr(ms){ return new Date(ms).toLocaleString(); }

// ==== —Ç–≤–æ–π API Worker ====
const API_BASE = "https://api-metals.analysisswim.workers.dev";

  async function loadRatio(){
  try{
    const r = await fetch(`${API_BASE}/api/ratio/gold-silver`, {
      cache: "no-store"
    });

    const ct = r.headers.get("content-type") || "";
    if(!ct.includes("application/json")){
      const raw = await r.text();
      throw new Error("Ratio not JSON: " + raw.slice(0,120));
    }

    const j = await r.json();
    if(j?.ratio == null) throw new Error("ratio missing");

    $("ratio").textContent = j.ratio.toFixed(2);

    if(j.ratio > 80){
      $("ratioSignal").textContent = "üü¢ –°–µ—Ä–µ–±—Ä–æ —Å–∏–ª—å–Ω–æ –Ω–µ–¥–æ–æ—Ü–µ–Ω–µ–Ω–æ (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞)";
    } else if(j.ratio < 60){
      $("ratioSignal").textContent = "üî¥ –°–µ—Ä–µ–±—Ä–æ –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–æ (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ)";
    } else {
      $("ratioSignal").textContent = "‚ö™ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω";
    }

  }catch(e){
    console.error(e);
    $("ratio").textContent = "‚Äî";
    $("ratioSignal").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ratio";
  }
}


// ===== FX =====
let FX_USD_SGD = 1;
async function refreshFx(){
  try{
    const r = await fetch(`${API_BASE}/api/fx?base=USD&quote=SGD`, { cache:"no-store" });
    const j = await r.json();
    if(!j?.ok) throw new Error(j?.error || "fx error");
    FX_USD_SGD = Number(j.rate) || 1;
    $("fx").textContent = num(FX_USD_SGD, 4);
  }catch(e){
    console.error(e);
    $("fx").textContent = "‚Äî";
    // –Ω–µ –≤–∞–ª–∏–º –≤—Å—ë, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏–º 1
  }
}
function toCcy(vUsd, ccy){
  if(vUsd==null) return null;
  if(ccy==="SGD") return vUsd * FX_USD_SGD;
  return vUsd;
}
function ccyLabel(ccy){ return ccy==="SGD" ? "SGD" : "USD"; }

// ===== Spot =====
async function fetchSpot(symbol){
  const r = await fetch(`${API_BASE}/api/spot?symbol=${encodeURIComponent(symbol)}`, { cache:"no-store" });
  const ct = (r.headers.get("content-type") || "");
  if (!ct.includes("application/json")) {
    const raw = await r.text();
    throw new Error("Spot not JSON: " + raw.slice(0,120));
  }
  const data = await r.json();
  if (data?.price == null) throw new Error("Spot missing price");
  return data;
}
async function refreshSpot(){
  $("spotXAU").textContent = "‚Äî";
  $("spotXAG").textContent = "‚Äî";
  $("spotSrc").textContent = "‚Äî";
  $("ratio").textContent = "‚Äî";
  try{
    const [xau,xag] = await Promise.all([fetchSpot("XAUUSD"), fetchSpot("XAGUSD")]);
    const ccy = $("ccy").value;
    const xauC = toCcy(xau.price, ccy);
    const xagC = toCcy(xag.price, ccy);

    $("spotXAU").textContent = num(xauC, 2) + " " + ccyLabel(ccy);
    $("spotXAG").textContent = num(xagC, 3) + " " + ccyLabel(ccy);
    $("spotSrc").textContent = xau.source || "‚Äî";

    // ratio –≤—Å–µ–≥–¥–∞ –ª—É—á—à–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ USD (–Ω–æ –º–æ–∂–Ω–æ –∏ –≤ SGD ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤–æ)
    $("ratio").textContent = num((xau.price / xag.price), 2);
  }catch(e){
    console.error(e);
    $("spotSrc").textContent = "–æ—à–∏–±–∫–∞ (—Å–º. —Å–æ—Å—Ç–æ—è–Ω–∏–µ/console)";
    setState("Spot –æ—à–∏–±–∫–∞: " + e.message, "status-bad");
  }
}
  
  <div class="box" style="margin-bottom:12px">
  <div style="font-weight:700;margin-bottom:6px">
    Gold / Silver Ratio
  </div>

  <div class="kpi" style="font-size:18px">
    <span id="ratio">‚Äî</span>
  </div>

  <div class="small" id="ratioSignal" style="margin-top:6px">
    ‚Äî
  </div>
</div>


// ===== Klines (Kraken —á–µ—Ä–µ–∑ Worker) =====
async function fetchKlines(pair, days=30, limit=200){
  const interval = 60; // 1h
  const url =
    `${API_BASE}/api/klines?market=kraken` +
    `&pair=${encodeURIComponent(pair)}` +
    `&days=${encodeURIComponent(days)}` +
    `&interval=${encodeURIComponent(interval)}` +
    `&limit=${encodeURIComponent(limit)}`;

  const r = await fetch(url, { cache:"no-store" });
  const data = await r.json();
  if(!data?.ok) throw new Error((data?.error || "klines error") + (data?.hint ? " | " + data.hint : ""));
  if(!Array.isArray(data.candles) || data.candles.length===0) throw new Error("Bad klines payload");

  // candles: [[ts,o,h,l,c],...]
  return { candles: data.candles, meta: data };
}

// ===== Indicators =====
function SMA(values, period){
  const out = Array(values.length).fill(null);
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i>=period) sum -= values[i-period];
    if(i>=period-1) out[i] = sum/period;
  }
  return out;
}
function RSI(closes, period){
  const out = Array(closes.length).fill(null);
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    const diff = closes[i]-closes[i-1];
    if(diff>=0) gains += diff; else losses -= diff;
  }
  let avgG = gains/period, avgL = losses/period;
  out[period] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  for(let i=period+1;i<closes.length;i++){
    const diff = closes[i]-closes[i-1];
    const g = diff>0 ? diff : 0;
    const l = diff<0 ? -diff : 0;
    avgG = (avgG*(period-1)+g)/period;
    avgL = (avgL*(period-1)+l)/period;
    out[i] = avgL===0 ? 100 : (100 - (100/(1+(avgG/avgL))));
  }
  return out;
}
function ATR(ohlc, period){
  const out = Array(ohlc.length).fill(null);
  const tr = Array(ohlc.length).fill(null);
  for(let i=0;i<ohlc.length;i++){
    const [, ,h,l,] = ohlc[i];
    if(i===0){ tr[i]=h-l; continue; }
    const prevClose = ohlc[i-1][4];
    tr[i] = Math.max(h-l, Math.abs(h-prevClose), Math.abs(l-prevClose));
  }
  let sum=0;
  for(let i=0;i<ohlc.length;i++){
    sum += tr[i];
    if(i>=period) sum -= tr[i-period];
    if(i>=period-1) out[i]=sum/period;
  }
  return out;
}

// ===== Chart + hover tooltip =====
let LAST_SERIES = null;

function drawChart(canvas, candles, maF, maS, ccy){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  const padL=60, padR=18, padT=18, padB=28;
  const plotW = w-padL-padR, plotH=h-padT-padB;

  const closesUsd = candles.map(x=>x[4]);
  const closes = closesUsd.map(v => toCcy(v, ccy));

  const min = Math.min(...closes), max = Math.max(...closes);
  const y = (v)=> padT + (max-v)/(max-min||1)*plotH;
  const x = (i)=> padL + (i/(candles.length-1||1))*plotW;

  // grid
  ctx.globalAlpha=0.55;
  ctx.strokeStyle="rgba(255,255,255,.08)";
  for(let i=0;i<=5;i++){
    const yy = padT + (i/5)*plotH;
    ctx.beginPath(); ctx.moveTo(padL,yy); ctx.lineTo(w-padR,yy); ctx.stroke();
  }
  ctx.globalAlpha=1;

  // price line
  ctx.strokeStyle="rgba(255,255,255,.88)";
  ctx.lineWidth=1.2;
  ctx.beginPath();
  closes.forEach((c,i)=>{ const xx=x(i), yy=y(c); if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy); });
  ctx.stroke();

  // MA fast (green)
  ctx.strokeStyle="rgba(59,214,113,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  let started=false;
  maF.forEach((vUsd,i)=>{ if(vUsd==null) return; const v = toCcy(vUsd, ccy); const xx=x(i), yy=y(v); if(!started){ctx.moveTo(xx,yy); started=true;} else ctx.lineTo(xx,yy); });
  ctx.stroke();

  // MA slow (red)
  ctx.strokeStyle="rgba(255,107,107,.9)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  started=false;
  maS.forEach((vUsd,i)=>{ if(vUsd==null) return; const v = toCcy(vUsd, ccy); const xx=x(i), yy=y(v); if(!started){ctx.moveTo(xx,yy); started=true;} else ctx.lineTo(xx,yy); });
  ctx.stroke();

  // labels
  ctx.fillStyle="rgba(168,179,207,1)";
  ctx.font="12px system-ui";
  ctx.fillText(num(max,2) + " " + ccyLabel(ccy), 8, padT+10);
  ctx.fillText(num(min,2) + " " + ccyLabel(ccy), 8, padT+plotH);
}

function bindHover(){
  const canvas = $("chart");
  const tip = $("tip");

  canvas.addEventListener("mousemove", (e) => {
    if(!LAST_SERIES) return;

    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (canvas.width / rect.width);

    const padL=60, padR=18;
    const plotW = canvas.width - padL - padR;

    const n = LAST_SERIES.candles.length;
    const rel = Math.max(0, Math.min(1, (mx - padL) / (plotW || 1)));
    const idx = Math.round(rel * (n-1));
    const c = LAST_SERIES.candles[idx];
    if(!c) return;

    const [ts,o,h,l,cl] = c;
    const ccy = $("ccy").value;

    tip.style.display = "block";
    tip.innerHTML =
      `<div><b>${LAST_SERIES.pair}</b> ¬∑ ${new Date(ts).toLocaleString()}</div>` +
      `<div>O: ${num(toCcy(o,ccy),2)} ¬∑ H: ${num(toCcy(h,ccy),2)} ¬∑ L: ${num(toCcy(l,ccy),2)} ¬∑ C: ${num(toCcy(cl,ccy),2)} ${ccyLabel(ccy)}</div>`;

    // –ø–æ–∑–∏—Ü–∏—è
    tip.style.left = Math.min(rect.width - 10, (e.clientX - rect.left) + 14) + "px";
    tip.style.top  = Math.max(10, (e.clientY - rect.top) - 10) + "px";
  });

  canvas.addEventListener("mouseleave", ()=>{ tip.style.display="none"; });
}

// ===== Main =====
async function loadAll(){
  setState("–ó–∞–≥—Ä—É–∂–∞—é klines‚Ä¶", "status-warn");
  $("rows").innerHTML = `<tr><td colspan="6" class="small">–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>`;

  const pair = $("asset").value;
  const days = Number($("days").value);
  const limit = Number($("limit").value);
  const ccy = $("ccy").value;

  const maFast = Math.max(2, Number($("maFast").value||9));
  const maSlow = Math.max(maFast+1, Number($("maSlow").value||21));
  const rsiP = Math.max(2, Number($("rsiP").value||14));
  const atrP = Math.max(2, Number($("atrP").value||14));
  const buyRSI = Number($("buyRSI").value||55);
  const sellRSI = Number($("sellRSI").value||65);
  const stopX = Number($("stopX").value||2);
  const tpX = Number($("tpX").value||3);

  try{
    const { candles, meta } = await fetchKlines(pair, days, limit);

    const closes = candles.map(x=>x[4]);        // USD
    const maF = SMA(closes, maFast);
    const maS = SMA(closes, maSlow);
    const rsi = RSI(closes, rsiP);
    const atr = ATR(candles, atrP);

    const lastIdx = candles.length-1;
    const lastCloseUsd = closes[lastIdx];
    const lastClose = toCcy(lastCloseUsd, ccy);

    $("last").textContent = num(lastClose,2) + " " + ccyLabel(ccy);
    $("ts").textContent = new Date().toLocaleString();

    let signal = "NEUTRAL";
    const prev = lastIdx-1;

    const crossUp = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] <= maS[prev]) && (maF[lastIdx] > maS[lastIdx]);

    const crossDn = prev>=0 && maF[prev]!=null && maS[prev]!=null && maF[lastIdx]!=null && maS[lastIdx]!=null
      && (maF[prev] >= maS[prev]) && (maF[lastIdx] < maS[lastIdx]);

    const rsiLast = rsi[lastIdx];
    const atrLastUsd = atr[lastIdx];

    let stopUsd=null, tpUsd=null;

    if(crossUp && rsiLast!=null && rsiLast < buyRSI){
      signal = "BUY";
      if(atrLastUsd!=null){ stopUsd = lastCloseUsd - atrLastUsd*stopX; tpUsd = lastCloseUsd + atrLastUsd*tpX; }
    } else if(crossDn && rsiLast!=null && rsiLast > sellRSI){
      signal = "SELL";
      if(atrLastUsd!=null){ stopUsd = lastCloseUsd + atrLastUsd*stopX; tpUsd = lastCloseUsd - atrLastUsd*tpX; }
    }

    const stop = toCcy(stopUsd, ccy);
    const tp   = toCcy(tpUsd, ccy);
    const atrLast = toCcy(atrLastUsd, ccy);

    $("signal").textContent =
      `–°–∏–≥–Ω–∞–ª: ${signal} ¬∑ Close=${num(lastClose,2)} ¬∑ RSI=${num(rsiLast,1)} ¬∑ Stop‚âà${num(stop,2)} ¬∑ TP‚âà${num(tp,2)} (ATR=${num(atrLast,2)}) ${ccyLabel(ccy)}`;

    const rows = [];
    for(let i=Math.max(0,lastIdx-11); i<=lastIdx; i++){
      rows.push(`
        <tr>
          <td>${tsToStr(candles[i][0])}</td>
          <td>${num(toCcy(closes[i],ccy),2)}</td>
          <td>${num(toCcy(maF[i],ccy),2)}</td>
          <td>${num(toCcy(maS[i],ccy),2)}</td>
          <td>${num(rsi[i],1)}</td>
          <td>${num(toCcy(atr[i],ccy),2)}</td>
        </tr>
      `);
    }
    $("rows").innerHTML = rows.join("");

    drawChart($("chart"), candles, maF, maS, ccy);

    LAST_SERIES = { pair, candles, meta };
    setState(`OK: klines —Å Kraken (resolved: ${meta.resolvedPair || meta.resultKey || "‚Äî"})`, "status-ok");
  }catch(e){
    console.error(e);
    setState("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + e.message, "status-bad");
    $("signal").textContent = "‚Äî";
    $("rows").innerHTML = `<tr><td colspan="6" class="small">‚Äî</td></tr>`;
    LAST_SERIES = null;
  }
}

function resetUI(){
  $("ts").textContent = "‚Äî";
  $("last").textContent = "‚Äî";
  $("signal").textContent = "‚Äî";
  $("rows").innerHTML = `<tr><td colspan="6" class="small">‚Äî</td></tr>`;
  const ctx = $("chart").getContext("2d");
  ctx.clearRect(0,0,$("chart").width,$("chart").height);
  $("tip").style.display="none";
  setState("–°–±—Ä–æ—à–µ–Ω–æ", "");
}

// handlers
$("loadBtn").addEventListener("click", loadAll);
$("resetBtn").addEventListener("click", resetUI);
$("spotBtn").addEventListener("click", async ()=>{ await refreshFx(); await refreshSpot(); });
$("ccy").addEventListener("change", async ()=>{ await refreshFx(); await refreshSpot(); if(LAST_SERIES) loadAll(); });

// —Å—Ç–∞—Ä—Ç
resetUI();
refreshSpot();
loadRatio();
(async ()=>{
  await refreshFx();
  await refreshSpot();
  await loadAll(); // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
})();
</script>
</body>
</html>
